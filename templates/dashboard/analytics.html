{% extends 'dashboard/base/base.html' %}
{% load humanize %}

{% block title %}Analytics | Dashboard{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Post Analytics</h1>
        <div class="btn-group btn-group-sm js-analytics-range-btns" role="group">
            <a href="?range=1" class="btn {% if range_param == '1' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Today</a>
            <a href="?range=3" class="btn {% if range_param == '3' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Last 3 days</a>
            <a href="?range=7" class="btn {% if range_param == '7' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Last 7 days</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Total Views
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_views }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        Total Likes
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_likes }}</div>
                </div>
            </div>
        </div>
    </div>

    <div id="analytics-charts-container">
    {% for item in posts_data %}
        {% with post=item.post chart_days=item.chart_days reactions=item.reaction_counts %}
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h5 class="mb-1">
                            <a href="{% url 'post' post.id %}">{{ post.title }}</a>
                        </h5>
                        <small class="text-muted">
                            {{ post.created_at|naturalday }} ¬∑ {{ post.visit_count }} total views ¬∑ {{ item.period_total }} views {{ range_label|lower }}
                        </small>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="font-weight-bold mb-2">Views ({{ range_label }})</h6>
                        <div class="d-flex align-items-end border rounded p-3 bg-light" style="height: 140px;">
                            {% for day in chart_days %}
                                <div class="text-center mx-1 flex-grow-1 d-flex flex-column align-items-center justify-content-end" style="min-width: 0;">
                                    <div class="mb-1" style="height: 80px; width: 100%; max-width: 48px; display: flex; align-items: flex-end; justify-content: center;">
                                        <div class="rounded-top w-100" style="background: linear-gradient(180deg, #4e73df 0%, #224abe 100%); height: {{ day.height }}%; min-height: 4px;" title="{{ day.date|date:'M d' }}: {{ day.views }} views"></div>
                                    </div>
                                    <small class="d-block text-muted" style="font-size: 11px;">
                                        {{ day.date|date:"D" }}<br><strong>{{ day.views }}</strong>
                                    </small>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="font-weight-bold mb-2">Reactions</h6>
                        <ul class="list-unstyled mb-0">
                            <li>üëç like: {{ reactions.like }}</li>
                            <li>‚ù§Ô∏è love: {{ reactions.love }}</li>
                            <li>üëè clap: {{ reactions.clap }}</li>
                            <li>üí° insightful: {{ reactions.insightful }}</li>
                            <li>üëé dislike: {{ reactions.dislike }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
    {% empty %}
        <div class="card shadow mb-4">
            <div class="card-body">
                <p class="mb-0">No posts yet.</p>
            </div>
        </div>
    {% endfor %}
    </div>
</div>
<script>
(function() {
    var container = document.getElementById('analytics-charts-container');
    var btnGroup = document.querySelector('.js-analytics-range-btns');
    if (!container || !btnGroup) return;
    btnGroup.addEventListener('click', function(e) {
        var a = e.target.closest('a[href^="?"]');
        if (!a) return;
        e.preventDefault();
        var url = a.getAttribute('href');
        var range = (url.match(/range=([137])/) || [])[1];
        if (!range) return;
        var req = new XMLHttpRequest();
        req.open('GET', window.location.pathname + url + '&partial=1');
        req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        req.onload = function() {
            if (req.status >= 200 && req.status < 300) {
                container.innerHTML = req.responseText;
                btnGroup.querySelectorAll('a').forEach(function(link) {
                    link.classList.toggle('btn-primary', link.getAttribute('href').indexOf('range=' + range) !== -1);
                    link.classList.toggle('btn-outline-secondary', link.getAttribute('href').indexOf('range=' + range) === -1);
                });
                history.replaceState(null, '', window.location.pathname + url);
            }
        };
        req.send();
    });
})();
</script>
{% endblock %}

